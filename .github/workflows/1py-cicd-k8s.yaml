name: python-ci-cd

on: push

jobs:
  j1:
    runs-on: [self-hosted, k8s]

    steps:
      - name: Checkout
        uses: actions/checkout@v3 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # SonarScanner requires Java
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          architecture: 'aarch64'

      - name: Install dependencies
        working-directory: src/apps
        run: |
          pip install -r requirements.txt

      - name: Run Pytest with coverage
        working-directory: src/apps
        run: |
          pytest \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml

      # ðŸ”½ðŸ”½ðŸ”½ INSTALL SONARSCANNER (REQUIRED) ðŸ”½ðŸ”½ðŸ”½
      - name: Install SonarScanner
        run: |
          curl -sSLo sonar-scanner.zip \
            https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux.zip
          unzip sonar-scanner.zip
          sudo mv sonar-scanner-* /opt/sonar-scanner
          sudo ln -s /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
          sonar-scanner --version

      # ðŸ”½ðŸ”½ðŸ”½ PROJECT CONFIG (NO TOKEN HERE) ðŸ”½ðŸ”½ðŸ”½
      - name: Create sonar-project.properties
        working-directory: src/apps
        run: |
          cat > sonar-project.properties << EOF
          sonar.projectKey=test1
          sonar.host.url=http://20.125.27.209:9000
          sonar.python.coverage.reportPaths=coverage.xml
          sonar.coverage.exclusions=**/test_*.py,**/*_test.py
          EOF

      # ðŸ”½ðŸ”½ðŸ”½ RUN SONAR SCAN (AUTH VIA TOKEN) ðŸ”½ðŸ”½ðŸ”½
      - name: Run SonarQube Scan
        working-directory: src/apps
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          sonar-scanner \
            -Dsonar.login=$SONAR_TOKEN \
            -Dsonar.scanner.skipJreProvisioning=true

      # ðŸ”½ðŸ”½ðŸ”½ QUALITY GATE ðŸ”½ðŸ”½ðŸ”½
      - name: Sonar Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        with:
          scanMetadataReportFile: src/apps/.sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://20.125.27.209:9000

      # ðŸ”½ðŸ”½ðŸ”½ BUILDKIT (UNCHANGED) ðŸ”½ðŸ”½ðŸ”½
      - name: Install buildkit CLI
        run: |
          curl -L https://github.com/moby/buildkit/releases/download/v0.13.2/buildkit-v0.13.2.linux-arm64.tar.gz \
          | tar -xz
          sudo mv bin/buildctl /usr/local/bin/buildctl
          sudo chmod +x /usr/local/bin/buildctl
          buildctl --addr tcp://localhost:1234 debug workers

      - name: Login to GHCR
        uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ secrets.GHCRA }}
          password: ${{ secrets.GHCRP }}

      - name: Build image via remote BuildKitd
        working-directory: src/
        run: |
          buildctl build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --output type=image,name=ghcr.io/gh-actions-learning/app:v1,push=true
        env:
          BUILDKIT_HOST: tcp://localhost:1234
