name: python-ci-cd

on: push

jobs:
  test-and-build:
    runs-on: [self-hosted, k8s]

    steps:
      # ==================== CHECKOUT ====================
      - name: Checkout code
        uses: actions/checkout@v4

      # ==================== SETUP ====================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup Java (required for SonarScanner)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          architecture: 'aarch64'

      # ==================== CACHING ====================
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      # ==================== DEPENDENCIES ====================
      - name: Install Python dependencies
        working-directory: src/apps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      # ==================== SONARSCANNER ====================
      - name: Install SonarScanner
        run: |
          set -e
          SC_VERSION="5.0.1.3006"
          SC_DIR="/opt/sonar-scanner"
          SC_ZIP="sonar-scanner-cli-${SC_VERSION}-linux-aarch64.zip"
          SC_URL="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/${SC_ZIP}"

          echo "ðŸ” Checking SonarScanner installation..."
          if [ -d "${SC_DIR}" ]; then
            echo "âœ… SonarScanner already installed at ${SC_DIR}"
          else
            echo "â¬‡ï¸ Downloading SonarScanner ${SC_VERSION} for ARM64..."
            curl -fLo "$SC_ZIP" "$SC_URL"
            if [ ! -f "$SC_ZIP" ] || [ ! -s "$SC_ZIP" ]; then
              echo "âŒ Failed to download SonarScanner. Check URL/network."
              exit 1
            fi
            echo "ðŸ“¦ Extracting..."
            unzip -q "$SC_ZIP"
            sudo mv sonar-scanner-* "$SC_DIR"
            rm "$SC_ZIP"
            if [ -d "${SC_DIR}/jre" ]; then
              echo "ðŸ—‘ Removing bundled JRE..."
              sudo rm -rf "${SC_DIR}/jre"
            fi
            sudo ln -sf "${SC_DIR}/bin/sonar-scanner" /usr/local/bin/sonar-scanner
            echo "âœ… SonarScanner installed successfully"
          fi

          export PATH="${JAVA_HOME}/bin:${PATH}"
          echo "â˜• Java version:"
          java -version
          echo "ðŸ”Ž SonarScanner version:"
          sonar-scanner --version

      # ==================== TESTING ====================
      - name: Run tests with coverage
        id: pytest
        working-directory: src/apps
        run: |
          pytest \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --junitxml=pytest-results.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: src/apps/coverage.xml

      # ==================== CODE QUALITY ====================
      - name: SonarQube Scan
        working-directory: src/apps
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://20.125.27.209:9000
          JAVA_HOME: ${{ env.JAVA_HOME }}
          PATH: ${{ env.JAVA_HOME }}/bin:${{ env.PATH }}
        run: |
          echo "Starting SonarQube scan..."
          echo "Java: $(which java)"
          echo "SonarScanner: $(which sonar-scanner)"
          sonar-scanner \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Dsonar.verbose=true

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        with:
          scanMetadataReportFile: src/apps/.sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://20.125.27.209:9000

      # ==================== BUILD & PUSH ====================
      - name: Install BuildKit CLI
        run: |
          if [ ! -f "/usr/local/bin/buildctl" ]; then
            curl -L https://github.com/moby/buildkit/releases/download/v0.13.2/buildkit-v0.13.2.linux-arm64.tar.gz \
            | tar -xz
            sudo mv bin/buildctl /usr/local/bin/buildctl
            sudo chmod +x /usr/local/bin/buildctl
          fi
          buildctl --version

      - name: Verify BuildKit connection
        run: |
          if ! buildctl --addr tcp://localhost:1234 debug workers; then
            echo "âŒ BuildKitd is not accessible at localhost:1234"
            exit 1
          fi
          echo "âœ… BuildKit connection successful"

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "additional_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "tag=develop" >> $GITHUB_OUTPUT
            echo "additional_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "additional_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        working-directory: src/
        env:
          BUILDKIT_HOST: tcp://localhost:1234
          IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/app
        run: |
          echo "ðŸ”¨ Building image: ${IMAGE_NAME}:${{ steps.tag.outputs.tag }}"
          TAGS="${IMAGE_NAME}:${{ steps.tag.outputs.tag }}"
          if [ -n "${{ steps.tag.outputs.additional_tag }}" ]; then
            TAGS="${TAGS},${IMAGE_NAME}:${{ steps.tag.outputs.additional_tag }}"
          fi
          buildctl build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --output type=image,name=${TAGS},push=true
          echo "âœ… Image pushed successfully"
          echo "ðŸ“¦ Tags: ${TAGS}"

      # ==================== SUMMARY ====================
      - name: Workflow Summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** 3.9" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Step Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ steps.pytest.outcome }}" >> $GITHUB_STEP_SUMMARY
