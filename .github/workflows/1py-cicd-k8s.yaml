name: python-ci-cd

on: push

jobs:
  test-and-build:
    runs-on: [self-hosted, k8s]
    
    steps:
      # ==================== CHECKOUT ====================
      - name: Checkout code
        uses: actions/checkout@v4

      # ==================== SETUP ====================
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Setup Java (required for SonarScanner)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          architecture: 'aarch64'

      # ==================== CACHING ====================
      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Cache SonarScanner
        uses: actions/cache@v4
        with:
          path: /opt/sonar-scanner
          key: sonar-scanner-5.0.1.3006-aarch64-no-jre-v1

      # ==================== DEPENDENCIES ====================
      - name: Install Python dependencies
        working-directory: src/apps
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest pytest-cov

      - name: Install SonarScanner
        run: |
          if [ ! -d "/opt/sonar-scanner" ]; then
            echo "Installing SonarScanner for ARM64..."
            curl -sSLo sonar-scanner.zip \
              https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006-linux-aarch64.zip
            unzip -q sonar-scanner.zip
            sudo mv sonar-scanner-* /opt/sonar-scanner
            echo "âœ… SonarScanner installed"
          else
            echo "âœ… SonarScanner found in cache"
          fi
          
          # ALWAYS remove bundled JRE (even from cache) - use system Java instead
          if [ -d "/opt/sonar-scanner/jre" ]; then
            echo "Removing incompatible bundled JRE..."
            sudo rm -rf /opt/sonar-scanner/jre
            echo "âœ… Bundled JRE removed - will use system Java"
          fi
          
          sudo ln -sf /opt/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner
          
          echo ""
          echo "Verifying installation..."
          echo "Java location: $JAVA_HOME"
          java -version
          echo ""
          echo "SonarScanner version:"
          SONAR_SCANNER_OPTS="-Djava.home=$JAVA_HOME" sonar-scanner --version

      # ==================== TESTING ====================
      - name: Run tests with coverage
        id: pytest
        working-directory: src/apps
        run: |
          pytest \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml \
            --junitxml=pytest-results.xml

      - name: Upload coverage report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: src/apps/coverage.xml

      # ==================== CODE QUALITY ====================
      - name: SonarQube Scan
        working-directory: src/apps
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://20.125.27.209:9000
          JAVA_HOME: ${{ env.JAVA_HOME }}
        run: |
          sonar-scanner \
            -Dsonar.token=$SONAR_TOKEN \
            -Dsonar.host.url=$SONAR_HOST_URL \
            -Djava.home=$JAVA_HOME \
            -Dsonar.verbose=true

      - name: SonarQube Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        with:
          scanMetadataReportFile: src/apps/.sonar/report-task.txt
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          SONAR_HOST_URL: http://20.125.27.209:9000

      # ==================== BUILD & PUSH ====================
      - name: Install BuildKit CLI
        run: |
          if [ ! -f "/usr/local/bin/buildctl" ]; then
            curl -L https://github.com/moby/buildkit/releases/download/v0.13.2/buildkit-v0.13.2.linux-arm64.tar.gz \
            | tar -xz
            sudo mv bin/buildctl /usr/local/bin/buildctl
            sudo chmod +x /usr/local/bin/buildctl
          fi
          buildctl --version

      - name: Verify BuildKit connection
        run: |
          if ! buildctl --addr tcp://localhost:1234 debug workers; then
            echo "âŒ BuildKitd is not accessible at localhost:1234"
            echo "Ensure BuildKitd is running in your cluster"
            exit 1
          fi
          echo "âœ… BuildKit connection successful"

      - name: Set image tag
        id: tag
        run: |
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            echo "tag=latest" >> $GITHUB_OUTPUT
            echo "additional_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref }}" == "refs/heads/develop" ]]; then
            echo "tag=develop" >> $GITHUB_OUTPUT
            echo "additional_tag=${{ github.sha }}" >> $GITHUB_OUTPUT
          else
            echo "tag=${{ github.sha }}" >> $GITHUB_OUTPUT
            echo "additional_tag=" >> $GITHUB_OUTPUT
          fi

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        working-directory: src/
        env:
          BUILDKIT_HOST: tcp://localhost:1234
          IMAGE_NAME: ghcr.io/${{ github.repository_owner }}/app
        run: |
          echo "ðŸ”¨ Building image: ${IMAGE_NAME}:${{ steps.tag.outputs.tag }}"
          
          TAGS="${IMAGE_NAME}:${{ steps.tag.outputs.tag }}"
          if [ -n "${{ steps.tag.outputs.additional_tag }}" ]; then
            TAGS="${TAGS},${IMAGE_NAME}:${{ steps.tag.outputs.additional_tag }}"
          fi
          
          buildctl build \
            --frontend dockerfile.v0 \
            --local context=. \
            --local dockerfile=. \
            --output type=image,name=${TAGS},push=true
          
          echo "âœ… Image pushed successfully"
          echo "ðŸ“¦ Tags: ${TAGS}"

      # ==================== SUMMARY ====================
      - name: Workflow Summary
        if: always()
        run: |
          echo "## Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Python:** 3.9" >> $GITHUB_STEP_SUMMARY
          echo "- **Image Tag:** ${{ steps.tag.outputs.tag }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Step Results" >> $GITHUB_STEP_SUMMARY
          echo "- Tests: ${{ steps.pytest.outcome }}" >> $GITHUB_STEP_SUMMARY