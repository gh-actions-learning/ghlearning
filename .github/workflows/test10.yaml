name: python-ci-cd

on: push

jobs:
  j1:
    runs-on: [self-hosted, k8s]
    steps:
      - name: checkout
        uses: actions/checkout@v3 

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      - name: Install dependencies
        working-directory: /home/runner/_work/ghlearning/ghlearning/src/apps
        run: |
          pip install -r requirements.txt

      - name: Run Pytest with coverage
        working-directory: src/apps
        run: |
          pytest \
            --cov=app \
            --cov-report=term-missing \
            --cov-report=xml
      
      - name: sonar qube scanner with pysonar
        working-directory: src/apps
        run: |
          pysonar \
            --sonar-host-url=http://20.125.27.209:9000 \
            --sonar-token=sqp_f98eb2ef625524f319264da61b4d650c6f89ba0b \
            --sonar-project-key=test \
            --coverage-report-path=coverage.xml

      - name: Sonar Quality Gate Check
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        with:
          scanMetadataReportFile: src/apps/.sonar/report-task.txt
        env:
          SONAR_TOKEN: sqp_f98eb2ef625524f319264da61b4d650c6f89ba0b
          SONAR_HOST_URL: http://20.125.27.209:9000
